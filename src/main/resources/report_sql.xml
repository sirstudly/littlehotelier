<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>Reporting SQL queries</comment>
    <entry key="reservations.split.rooms">
-- Query all unallocated reservations that span more than 1 room for the same room type
INSERT INTO wp_lh_rpt_split_rooms (job_id, reservation_id, guest_name, checkin_date, checkout_date, data_href, 
       notes, lh_status, booking_reference, booking_source, booked_date, eta, viewed_yn, created_date)
SELECT job_id, reservation_id, GROUP_CONCAT(distinct guest_name SEPARATOR ', ' ) guest_name, 
       checkin_date, checkout_date, data_href, notes, lh_status, booking_reference, 
       booking_source, booked_date, eta, viewed_yn, MAX(created_date) `created_date` 
  FROM wp_lh_calendar rep
 WHERE rep.job_id = :jobId -- the job_id of the AllocationScraperJob to use data for
   AND (
       EXISTS (
           -- all reservations where for the same room type, they are split into different rooms
           -- does not take into account group bookings
           SELECT t.job_id, t.reservation_id, t.room_type_id, count(1)
             FROM ( -- for each reservation, determine which rooms are they assigned to
                  SELECT c.job_id, c.reservation_id, rm.room, rm.room_type_id, count(1)
                    FROM wp_lh_calendar c
                    JOIN wp_lh_rooms rm ON c.room_id = rm.id 
                   WHERE rm.room_type NOT IN ('LT_MALE', 'LT_FEMALE', 'DBL', 'TRIPLE', 'QUAD', 'TWIN')
                     AND c.reservation_id > 0 -- do not include room closures
                     AND c.job_id = :jobId
                   GROUP BY c.job_id, c.reservation_id, rm.room, rm.room_type_id
              ) t
            WHERE t.reservation_id = rep.reservation_id
              AND t.job_id = rep.job_id
            GROUP BY t.reservation_id, t.room_type_id
           HAVING COUNT(1) > 1
       ) -- end exists
       OR EXISTS (
           -- include all reservations which have unallocated rooms
           SELECT c.job_id, c.reservation_id, c.room_type_id, 1
             FROM wp_lh_calendar c
            WHERE c.room_id IS NULL -- unallocated reservations don't have this set
              AND c.reservation_id = rep.reservation_id
              AND c.job_id = rep.job_id
       ) -- end exists
    )
 GROUP BY job_id, reservation_id, checkin_date, checkout_date, data_href, notes, lh_status, booking_reference, booking_source, booked_date, eta, viewed_yn
    </entry>
    <entry key="unpaid.deposit.report">
		INSERT INTO wp_lh_rpt_unpaid_deposit( job_id, guest_name, checkin_date, checkout_date, payment_total, data_href, booking_reference, booking_source, booked_date, notes, viewed_yn, created_date )
		SELECT job_id, GROUP_CONCAT( DISTINCT guest_name ) `guest_name`, checkin_date, checkout_date, payment_total, data_href, booking_reference, booking_source, booked_date, notes, viewed_yn, MAX(created_date) `created_date`
		  FROM wp_lh_calendar f  
		WHERE job_id = ?
		AND payment_total = payment_outstanding
		AND payment_total > 0
		AND booking_source IN ('Booking.com')
		GROUP BY reservation_id, checkin_date, checkout_date, payment_total, data_href, booking_reference, booking_source, booked_date, notes, viewed_yn;
    </entry>
    <entry key="group.bookings">
	    INSERT INTO `wp_lh_group_bookings` (job_id, reservation_id, guest_name, booking_reference, booking_source, checkin_date, checkout_date, booked_date, payment_outstanding, data_href, num_guests, notes, viewed_yn)
        SELECT job_id, reservation_id, GROUP_CONCAT(DISTINCT guest_name) `guest_name`, booking_reference, booking_source, checkin_date, checkout_date, booked_date, payment_outstanding, data_href, COUNT(num_guests) `num_guests`, notes, viewed_yn
          FROM ( -- some duplicates may occur; remove them first
                SELECT job_id, room, bed_name, reservation_id, guest_name, booking_reference, booking_source, checkin_date, checkout_date, booked_date, payment_outstanding, data_href, num_guests, notes, viewed_yn 
                  FROM wp_lh_calendar
                 WHERE job_id = ?
                   AND reservation_id > 0 -- ignore room closures
                 GROUP BY job_id, room, bed_name, reservation_id, guest_name, booking_reference, booking_source, checkin_date, checkout_date, booked_date, payment_outstanding, data_href, num_guests, notes, viewed_yn
                ) t
         WHERE reservation_id > 0 -- ignore room closures
      GROUP BY reservation_id, booking_reference, booking_source, checkin_date, checkout_date, booked_date, payment_outstanding, data_href, notes, viewed_yn
        HAVING COUNT(1) >= 6;
    </entry>
    <entry key="mismatched.bookings.hw">
SELECT x.*, y.*, z.* 
 FROM (
        SELECT DISTINCT t.booking_reference FROM (
        SELECT b.guest_name `hw_guest_name`, b.booking_reference, b.booked_date `booked_on`, d.room_type_id, d.booked_date, d.persons `hw_persons`, c.guest_name, 
               SUM(IF(c.guest_name IS NULL, 0, 1)) * IFNULL((SELECT MAX(r.capacity) FROM wp_lh_rooms r WHERE r.room_type IN ('DBL', 'TWIN', 'TRIPLE', 'QUAD') AND r.room_type_id = c.room_type_id), 1 ) `lh_persons`
          FROM wp_hw_booking b
          JOIN wp_hw_booking_dates d ON b.id = d.hw_booking_id
          LEFT OUTER JOIN wp_lh_calendar c ON c.booking_reference = CONCAT('HWL-551-', b.booking_reference) 
           AND c.job_id = 1017 
           AND c.checkin_date &lt;= d.booked_date
           AND c.checkout_date > d.booked_date
           AND c.room_type_id = d.room_type_id
         WHERE b.job_id = 2
         GROUP BY b.guest_name, b.booking_reference, b.booked_date, d.room_type_id, d.booked_date, d.persons, c.guest_name, c.room_type_id
        ) t
         WHERE t.hw_persons != t.lh_persons
) x
JOIN (SELECT b.booking_reference, b.guest_name, b.booked_date, b.persons, r.capacity, r.room_type,
               MIN(d.booked_date) `checkin_date`, DATE_ADD(MAX(d.booked_date), INTERVAL 1 DAY) `checkout_date`
          FROM wp_hw_booking b
          JOIN wp_hw_booking_dates d ON b.id = d.hw_booking_id
          JOIN (SELECT DISTINCT room_type_id, room_type, capacity FROM wp_lh_rooms) r ON r.room_type_id = d.room_type_id
         WHERE b.job_id = 2
         GROUP BY b.booking_reference, b.guest_name, b.booked_date, r.capacity, r.room_type
) y ON x.booking_reference = y.booking_reference
LEFT OUTER JOIN (
SELECT c.booking_reference, c.guest_name, c.booked_date, r.capacity, r.room_type, c.checkin_date, c.checkout_date,
       SUM(IFNULL((SELECT MAX(r.capacity) FROM wp_lh_rooms r WHERE r.room_type IN ('DBL', 'TWIN', 'TRIPLE', 'QUAD') AND r.room_type_id = c.room_type_id), 1 )) `lh_persons`
  FROM wp_lh_calendar c 
  JOIN (SELECT DISTINCT room_type_id, room_type, capacity FROM wp_lh_rooms) r ON r.room_type_id = c.room_type_id
 WHERE c.job_id = 1017
   AND c.booking_source = 'Hostelworld'
  GROUP BY c.booking_reference, c.guest_name, c.booked_date, r.capacity, r.room_type, c.checkin_date, c.checkout_date
) z ON CONCAT('HWL-551-', x.booking_reference) = z.booking_reference;
    </entry>
</properties>